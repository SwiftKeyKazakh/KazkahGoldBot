import os
from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ApplicationBuilder, CommandHandler, CallbackQueryHandler, MessageHandler, filters, ContextTypes

BOT_TOKEN = os.environ.get("BOT_TOKEN")
ADMIN_USERNAME = "@X6TREAKS"
REKVIZITY = "Kaspi: 4400 4302 0679 2373 (–ï–≤–≥–µ–Ω–∏–π –ì.)"
EXCHANGE_RATE = 500  # 100 –≥–æ–ª–¥—ã = 500 —Ç–µ–Ω–≥–µ

user_state = {}

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    kb = [
        [InlineKeyboardButton("üí∞ –ö—É–ø–∏—Ç—å –≥–æ–ª–¥—É", callback_data="buy")],
        [InlineKeyboardButton("üì∑ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —á–µ–∫", callback_data="chek")],
        [InlineKeyboardButton("üéØ –í—ã–≤–æ–¥", callback_data="sell")]
    ]
    await update.message.reply_text(
        "–ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç –º–∞–≥–∞–∑–∏–Ω–∞ *Kazakh Gold* ‚Äî –ø–æ–∫—É–ø–∞–π –∏ –≤—ã–≤–æ–¥–∏ –≥–æ–ª–¥—É –±—ã—Å—Ç—Ä–æ –∏ —É–¥–æ–±–Ω–æ!",
        reply_markup=InlineKeyboardMarkup(kb),
        parse_mode="Markdown"
    )

async def handle_buttons(update: Update, context: ContextTypes.DEFAULT_TYPE):
    query = update.callback_query
    await query.answer()

    if query.data == "buy":
        user_state[query.from_user.id] = "buy"
        await query.message.reply_text("–°–∫–æ–ª—å–∫–æ –≥–æ–ª–¥—ã —Ö–æ—Ç–∏—Ç–µ –∫—É–ø–∏—Ç—å?")

    elif query.data == "chek":
        await query.message.reply_text("–û—Ç–ø—Ä–∞–≤—å—Ç–µ —á–µ–∫ (—Ñ–æ—Ç–æ/—Å–∫—Ä–∏–Ω).")

    elif query.data == "sell":
        user_state[query.from_user.id] = "sell"
        await query.message.reply_text("–°–∫–æ–ª—å–∫–æ –≥–æ–ª–¥—ã —Ö–æ—Ç–∏—Ç–µ –≤—ã–≤–µ—Å—Ç–∏?")

    elif query.data.startswith("ok_"):
        user_id = int(query.data.split("_")[1])
        await context.bot.send_message(chat_id=user_id, text="‚úÖ –ß–µ–∫ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω! –ì–æ–ª–¥–∞ –∑–∞—á–∏—Å–ª–µ–Ω–∞.")
        await query.edit_message_text("–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–æ.")

    elif query.data.startswith("done_"):
        user_id = int(query.data.split("_")[1])
        await context.bot.send_message(chat_id=user_id, text="‚úÖ –ì–æ–ª–¥–∞ –≤—ã–≤–µ–¥–µ–Ω–∞ –Ω–∞ –≤–∞—à –∞–∫–∫–∞—É–Ω—Ç!")
        await query.edit_message_text("–í—ã–≤–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω.")

async def handle_text(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user_id = update.message.from_user.id
    username = update.message.from_user.username or "–±–µ–∑ –Ω–∏–∫–∞"
    text = update.message.text

    if user_state.get(user_id) == "buy":
        try:
            gold = int(text)
            price = gold * EXCHANGE_RATE // 100
            await update.message.reply_text(
                f"–¶–µ–Ω–∞: {gold} –≥–æ–ª–¥—ã = {price}‚Ç∏\n\n–†–µ–∫–≤–∏–∑–∏—Ç—ã:\n{REKVIZITY}\n\n–ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —á–µ–∫!"
            )
            user_state[user_id] = None
        except:
            await update.message.reply_text("–í–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ–ª–¥—ã —á–∏—Å–ª–æ–º.")

    elif user_state.get(user_id) == "sell":
        try:
            gold = int(text)
            market_price = round(gold * 1.25)  # 25% –∫–æ–º–∏—Å—Å–∏—è
            await update.message.reply_text(
                f"–ß—Ç–æ–±—ã –≤—ã–≤–µ—Å—Ç–∏ {gold} –≥–æ–ª–¥—ã, –≤—ã—Å—Ç–∞–≤—å—Ç–µ —Å–∫–∏–Ω –Ω–∞ –º–∞—Ä–∫–µ—Ç –∑–∞ *{market_price}* –≥–æ–ª–¥—ã.\n"
                f"(–ö–æ–º–∏—Å—Å–∏—è —É—á—Ç–µ–Ω–∞)", parse_mode="Markdown"
            )
            await context.bot.send_message(
                chat_id=ADMIN_USERNAME,
                text=f"üîÅ –ó–∞–ø—Ä–æ—Å –≤—ã–≤–æ–¥–∞:\n@{username}\n–ì–æ–ª–¥–∞: {gold}\n–¶–µ–Ω–∞ —Å —É—á—ë—Ç–æ–º –∫–æ–º–∏—Å—Å–∏–∏: {market_price}",
                reply_markup=InlineKeyboardMarkup([
                    [InlineKeyboardButton("‚úÖ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ", callback_data=f"done_{user_id}")]
                ])
            )
            user_state[user_id] = None
        except:
            await update.message.reply_text("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥–æ–ª–¥—ã —á–∏—Å–ª–æ–º.")

async def handle_photo(update: Update, context: ContextTypes.DEFAULT_TYPE):
    user = update.message.from_user
    uid = user.id
    username = user.username or "–±–µ–∑ –Ω–∏–∫–∞"
    caption = f"üßæ –ù–æ–≤—ã–π —á–µ–∫ –æ—Ç @{username}"

    await context.bot.send_photo(
        chat_id=ADMIN_USERNAME,
        photo=update.message.photo[-1].file_id,
        caption=caption,
        reply_markup=InlineKeyboardMarkup([[InlineKeyboardButton("‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å", callback_data=f"ok_{uid}")]])
    )
    await update.message.reply_text("–ß–µ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! –û–∂–∏–¥–∞–π—Ç–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.")

# –ó–∞–ø—É—Å–∫
app = ApplicationBuilder().token(BOT_TOKEN).build()
app.add_handler(CommandHandler("start", start))
app.add_handler(CallbackQueryHandler(handle_buttons))
app.add_handler(MessageHandler(filters.PHOTO, handle_photo))
app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_text))
app.run_polling()
